<h3 class="panel-heading" id="list-item-3" style="margin: 1rem 0 0rem 0 ;background-color: #17a2b8;color: #ffffff;">
    Heatmap/Time Series Trend Chart
</h3>
<div class="border border-secondary rounded" style="padding: 1rem;">
    <form id="Form1" action="/GeTeSEPdb/detail/{{ studyid }}" method="get">
        <div class="container col-12">
            <div class="row">
                <div class="form-group col-6" style="padding-left: 0rem;margin-bottom: 0.3125rem;">
                    <label for="ClusterForm1" style="margin-bottom: 0rem;">Cluster:</label>
                    <select class="form-control" id="ClusterForm1" onchange="updateCharts()" name="cluster">
                        {% for cluster_model_value in cluster_model_list %}
                        <option {% if cluster == cluster_model_value %} selected="selected" {% endif %} value='{{ cluster_model_value }}'>{{ cluster_model_value }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="container col-12">
    <div class="row">
        <div class="col-12" style="padding: 0;">
            <div id="heatmap" style="width: 100%;height:400px;"></div>
        </div>
    </div>
</div>

<div id="line-chart"></div>

<script type="application/json" id="heatmapData">{{ heatmap_data | safe }}</script>
<script type="application/json" id="trend_data">{{ trend_data | safe }}</script>
<script type="application/json" id="tread_data_line">{{ tread_data_line | safe }}</script>

<script>
	var heatmap_data = {{ heatmap_data | safe }};
	var trend_data = {{ trend_data | safe }};
	var trend_data_line = {{ tread_data_line | safe }}
	var x_Axis = {{ x_Axis | safe}}

	
    function updateCharts() {
        var selectedCluster = document.getElementById('ClusterForm1').value;
		console.log(selectedCluster)
        // Update heatmap
        var heatmapTrace = {
            type: 'heatmap',
            x: x_Axis,
            y: heatmap_data[selectedCluster].y,
            z: heatmap_data[selectedCluster].z,
            colorscale: [['0.0', 'rgb(94,79,162)'], ['0.1', 'rgb(50,136,189)'], ['0.2', 'rgb(102,194,165)'], ['0.3', 'rgb(171,221,164)'], ['0.4', 'rgb(230,245,152)'], ['0.5', 'rgb(255,255,191)'], ['0.6', 'rgb(254,224,139)'], ['0.7', 'rgb(253,174,97)'], ['0.8', 'rgb(244,109,67)'], ['0.9', 'rgb(213,62,79)'], ['1.0', 'rgb(158,1,66)']],
            showscale: true,
            colorbar: { title: 'Z-Score' },
        };

        var heatmapLayout = {
            title: 'Heatmap',
            bargap: 0.1,
            legend: {
                font: { color: '#666666' },
                bgcolor: '#FFFFFF',
                title: { text: 'z-Score' }
            },
            xaxis: {
                title: 'Time Series',
                showgrid: true,
                tickfont: { color: '#666666' },
                gridcolor: '#F6F6F6',
                titlefont: { color: '#666666' },
                zerolinecolor: '#F6F6F6'
            },
            yaxis: {
                title: 'Gene Name',
                showgrid: true,
                tickfont: { color: '#666666' },
                gridcolor: '#F6F6F6',
                titlefont: { color: '#666666' },
                zerolinecolor: '#F6F6F6',
                showticklabels: false,
                ticks: ''
            },
            titlefont: { color: '#151516' },
            plot_bgcolor: '#E5E5E5',
            paper_bgcolor: '#FFFFFF'
        };

        Plotly.newPlot('heatmap', [heatmapTrace], heatmapLayout);

        // Update line chart
        var time = trend_data[selectedCluster].x;
        var geneData = trend_data[selectedCluster].y;
            
        var traceData = [];
		for (var gene in geneData) {
			var trace = {
				x: x_Axis,
				y: geneData[gene],
				name: gene,
				type: 'scatter'
			};
			traceData.push(trace);
		}
		
		// Add the new line trace
		var newTrace = {
			x: trend_data_line[selectedCluster].x,
			y: trend_data_line[selectedCluster].y,
			mode: 'lines',
			name: 'fitting line',
			line: {
			        color: 'black', // 设置线条颜色为黑色
					width: 4
			    }
		};
		traceData.push(newTrace);
		
		// traceData.push(trace1,trace2);
		
        var lineChartLayout = {
            title: 'Time Series Trend Chart',
            xaxis: {
                title: 'Time Series'
            },
            yaxis: {
                title: 'Gene Expression Value'
            }
        };

        Plotly.newPlot('line-chart', traceData, lineChartLayout);
    }

    // Initialize the charts with the selected cluster
    updateCharts();
</script>