<!DOCTYPE html>
<html><!--result.html-->
<head>
    <title>Search</title>
	<meta charset="utf-8">

	{% include 'public_templates/bootstrap.html' %}
<!-- 	<script type="text/javascript">
		var jquery3 = jQuery.noConflict(true);
	</script> -->
	<!--第一步：引入Javascript / CSS （CDN）-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.12.1/css/jquery.dataTables.css"> 
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
	<!-- jQuery -->
	<!-- <script type="text/javascript" charset="utf8" src="/cellinteract_static/js/jquery-1.10.2.min.js"></script> -->
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
	<script type="text/javascript" charset="utf8" src="http://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<style>
	.dataTable {
		text-align: center;
	}
	td.studyId {
		color: #17a2b8;
		text-decoration: underline;
	}
	
	td.studyId:hover {
		color: #138496;
		cursor: pointer;
	}

	/* datatable button */
	.dt-button.icon_:before {
		color: #fff;
		padding-top: 10px;
		content: "\f019";
		font-family: FontAwesome;
		font-size: 20px;
	}
	.dt-button.icon_{
		background-color: #17a2b8;
		border-color: #17a2b8;
	}
	.dt-button {
		margin-top: 5px;
	}
	/* datatable search */
	.dataTables_filter {
		margin-top: 5px;
	}
	/* datatable info */
	.dataTables_info {
		margin-left: -30px;
	}

	.dataTables_length {
		margin-top: 5px;
	}

	</style>
	<style>
		.index {
			font-size: 1.9rem;
		}

		a {
			margin-left: 5px;
		}
		.table /* thead */ /* tbody */ tr td{
			max-width: 300px;
			background-color: aliceblue;
		    overflow: hidden;
		    text-overflow:ellipsis;
		    white-space: nowrap;
			text-align: center;
			vertical-align: middle;
		 }
		.table /* thead */ /* tbody */ tr th{
		 	text-align: center;
		}
		.right {
		        position: absolute;
		        right: 0px;
		}
		td.studyId {
			color: #17a2b8;
			text-decoration: underline;
		}
		
		td.studyId:hover {
			color: #138496;
			cursor: pointer;
		}
		td.genename {
			color: #17a2b8;
			text-decoration: underline;
		}
		
		td.genename:hover {
			color: #138496;
			cursor: pointer;
		}
	</style>
	<script type="text/javascript">
		// 加载提示框
		$(document).ready(function() {
			// 导航栏加亮
			// jquery3("#nav_search").addClass("active");
			$("#page_title").text('RESULT');

			// $('[data-toggle="tooltip"]').tooltip();


			// $('[data-toggle="popover"]').popover({
			// 	trigger: 'hover',
			// 	html: true, //开启html 为true的话，data-content里就能放html代码了
			// 	content: '<img src="/pertorg_static/img/structures_svg/{{drug.drug_structure}}"'
			// });
		});
		document.onkeydown = function(event) {
		 var keyNum = window.event.keyCode
		 if (keyNum == 13) {
		  select_value = $(".sm_over").text()
		  console.log(select_value)
		  if (select_value != ""){
		   select_data($(".sm_over a").parent())
		  }
		
		 }
		
		}
		
	</script>
</head>
<body>
		{% include 'public_templates/nav_tem.html' %}
		{% include 'public_templates/page_title.html' %}

		{% csrf_token %}
		
		<div class="container col-9">
			<table id="Search_Single_datatable" class="display" style="width: 100%;">
				<thead>
					<tr>
						<th>Studyid</th>
						<th>Gene</th>
						<th>Tissue</th>
						<th>Organism</th>
						<th>Strategy</th>
						<th>Cluster</th>
						<th>Model</th>
						<th>Experiment type</th>
						<!-- <th>Trend Plot</th> -->
					</tr>
				</thead>
			</table>
			<table id="Search_dataset_datatable" class="display" style="width: 100%;">
				<thead>
					<tr>
						<th>Studyid</th>
						<th>Data accession</th>
						<th>Time</th>
						<th>Unit</th>
						<th>Time change factor</th>
						<th>Experiment type</th>
						<th>Drug</th>
						<th>Tissue/Cell type</th>
						<th>Organism</th>
					</tr>
				</thead>
			</table>
			<script>
				var result_information = {{ result_information |safe }};
				console.log('result_information:', result_information);
				var search_method = "{{ search_method }}";
				<!--第三步：初始化Datatables-->
				if (search_method=="gene_search") {
					var Search_Single_datatable = $('#Search_Single_datatable').DataTable({
					data: result_information,
					"dom": "<'row'<'col-sm-12 col-md-1'B><'col-sm-12 col-md-8'i><'col-sm-12 col-md-3'f>>" +
						"<'row'<'col-sm-12'tr>>" +
						"<'row'<'col-sm-12 col-md-5'l><'col-sm-12 col-md-7'p>>",
					buttons: [{
						extend: 'csv',
						text: "",
						className: "icon_",
						}],
					bAutoWidth: false,
					autoWidth: false,
					order: [[ 6, "desc" ]],
					columnDefs: [
						{ width: '10%', targets: 1 }
					  ],
					//使用对象数组，一定要配置columns，告诉 DataTables 每列对应的属性
					//data 这里是固定不变的，name，position，salary，office 为你数据里对应的属性
					columns: [
						{
							title: 'Project ID',
							data: 'studyid',
							className: 'studyId',
						},
						{
							title: 'Gene',
							data: 'gene',
							className: 'genename',
						},
						{
							data: 'tissue',
							// render: $.fn.dataTable.render.number('', '.', 3),
						},
						{
							data: 'organism',
							// render: $.fn.dataTable.render.number('', '.', 3),
						},
						{
							data: 'strategy',
						},
						{
							data: 'cluster',
						},
						{
							data: 'model',
						},
						{
							data: 'experiment_type',
						}
					]
					});
				} else{
					var Search_dataset_datatable = $('#Search_dataset_datatable').DataTable({
						data: result_information,
						"dom": "<'row'<'col-sm-12 col-md-1'B><'col-sm-12 col-md-8'i><'col-sm-12 col-md-3'f>>" +
							"<'row'<'col-sm-12'tr>>" +
							"<'row'<'col-sm-12 col-md-5'l><'col-sm-12 col-md-7'p>>",
						buttons: [{
							extend: 'csv',
							text: "",
							className: "icon_",
							}],
						bAutoWidth: false,
						autoWidth: false,
						order: [[ 1, "desc" ]],
						columnDefs: [
							{ width: '10%', targets: 1 }
						  ],
						//使用对象数组，一定要配置columns，告诉 DataTables 每列对应的属性
						//data 这里是固定不变的，name，position，salary，office 为你数据里对应的属性
						columns: [
							{
								title: 'Project ID',
								data: 'studyid',
								className: 'studyId',
							},
							{
								data: 'accession',
							},
							{
							    data: 'time',
							    "render": function(data, type, row, meta) {
							    if (type === 'display') {
							        var times = data.split(';');
							        var truncatedTimes = times.slice(0, 5).join(';');
							        if (times.length > 5) {
							            truncatedTimes += '...';
							        }
							        return truncatedTimes;
							        }
							    return data;
							    }
							},
							{
								
								data: 'unit',
							},
							{
								
								data: 'related_factor',
							},
							{
								data: 'experiment_type',
							},
							{
								
								data: 'drug',
							},
							{
								data: 'tissue_cell_type',
							},
							{
								data: 'organism',
							}
							
						]
					});
					}
					</script>
					<div id="searchPathwayChordModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
							<div class="modal-content">
							  <div class="modal-header">
								<h5 class="modal-title" id="exampleModalLongTitle">Gene trend chart</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								  <span aria-hidden="true">&times;</span>
								</button>
							  </div>
							  <div class="modal-body">
								  <div class="loader" id="loader_modal" style="display: none;">
								  </div>
								  <div id="line-chart" style="min-width:400px;height:400px"></div>
							  </div>
							</div>
						</div>
					</div>
		</div>
		<!-- 底栏 -->
		{% include 'public_templates/footer.html' %}
		<script type="text/javascript">
			function reset_example(){
				$("#exampleFormControlSelect1").val("");
				// $("#inputCity").val("");
				$("#organism").val("All Organisms");
				$("#tissue").val("All Tissues");
				$("#model_type").val("All Model Types");
				$("#data_type").val("All Data Types");
			}
				
				
			
			var csrftoken = $("input[name='csrfmiddlewaretoken']").attr('value');
			console.log(csrftoken)
		
			function odb_ajax(url, postData) {
				o_ajax = {
					type: 'POST',
					url: url,
					headers: {'X-CSRFToken': '{{csrf_token}}'},
					data: postData ,//used to pass data set choice i.e gtex or organoidDB
					processData:false,
					contentType:false,
				}
				return o_ajax;
			}
			
			$('#Search_Single_datatable').on('click', 'tbody button', function(){
			    var tr_data = Search_Single_datatable.row($(this).parents('tr')).data();
			    var optionData = new FormData();
			    optionData.append('studyid', tr_data.studyid);
			    optionData.append('cluster', tr_data.cluster);
			    optionData.append('gene', tr_data.gene);
			    gene = tr_data.gene;
			    $.ajax({
			        type: 'POST',
			        url: '/GeTeSEPdb/plot_trend',
			        headers: { "X-CSRFToken": '{{csrf_token}}' },
			        data: optionData,
			        processData: false,
			        contentType: false,
			        success: function(plot_data){
						plot_data = JSON.parse(plot_data);
						
			            var trend_data = plot_data.trend_data;
			            var tread_data_line = plot_data.tread_data_line;
						
			            var x_Axis = plot_data.x_Axis;
			
			            var time = trend_data.x;
			            var geneData = trend_data.y;
			            var gene = trend_data.z;
			            var traceData = [];
			            var trace1 = {
			                x: x_Axis,
			                y: geneData,
			                name: gene,
			                mode: 'markers'
			            };
			            var trace2 = {
			                x: tread_data_line.x,
			                y: tread_data_line.y,
			                mode: 'lines',
			                name: gene
			            };
			            traceData.push(trace1, trace2);
			
			            var lineChartLayout = {
			                title: gene + ' trend chart',
			                xaxis: {
			                    title: 'Time Series'
			                },
			                yaxis: {
			                    title: 'Gene Expression Value'
			                }
			            };
			
			            Plotly.newPlot('line-chart', traceData, lineChartLayout);
			            
			            $('#loader_modal').hide();
			            $('#search_model').show();
			        },
			        error: function(plot_single_result){
			            alert('Something went wrong');
			            console.log(plot_single_result);
			        }
			    });
			    
			    $('#exampleModalLongTitle').text(gene + ' trend chart');
			    $('#searchPathwayChordModal').modal('show');
			    $('#search_model').hide();
			    $('#loader_modal').show();
			});
			
			$('#Search_Single_datatable').on('click', 'tbody .studyId', function(){
				tr_data = Search_Single_datatable.row($(this).parents('tr')).data();
				studyid = tr_data.studyid;
				window.location = './detail/'+studyid;
			});
			
			$('#Search_Single_datatable').on('click', 'tbody .genename', function(){
				var tr_data = Search_Single_datatable.row($(this).parents('tr')).data();
				var tr_data = Search_Single_datatable.row($(this).parents('tr')).data();
				var studyid = tr_data.studyid
				var cluster = tr_data.cluster
				var gene = tr_data.gene
				window.location = "./gene_detail/" + gene + "?gene=" + gene + "&studyid=" + studyid + "&cluster=" + cluster;
			})		
			
			$('#Search_dataset_datatable').on('click', 'tbody .studyId', function(){
				tr_data = Search_dataset_datatable.row($(this).parents('tr')).data();
				studyid = tr_data.studyid;
				window.location = './detail/'+studyid;
			});
			
			var search_method = "{{ search_method }}";
			// console.log(123);
			// console.log("search_method:", search_method);
			if (search_method == 'gene_search') {
			    $("#Search_dataset_datatable").hide();
			    $("#Search_Single_datatable").show();
			} else {
			    $("#Search_dataset_datatable").show();
			     $("#Search_Single_datatable").hide();
			}
					
		</script>
</body>
</html>