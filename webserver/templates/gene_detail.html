<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Detail</title>
		{% include 'public_templates/bootstrap.html' %}
		<!-- <script src="https://lib.baomitu.com/echarts/5.2.0/echarts.min.js"></script> -->
		<script src="/timecourse_app_static/cdn/js/plotly-2.8.3.min.js"></script>
		<!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->
		<!--第一步：引入Javascript / CSS （CDN）-->
		<!-- DataTables CSS -->
		<link rel="stylesheet" type="text/css" href="/timecourse_app_static/cdn/css/jquery.dataTables.css">
		<!-- jQuery -->
		<script type="text/javascript" charset="utf8" src="/timecourse_app_static/cdn/js/jquery-1.10.2.min.js"></script>
		<!-- DataTables -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		
		<script type="text/javascript" charset="utf8" src="/timecourse_app_static/cdn/js/jquery.dataTables.js"></script>
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
		<style>

			.dataTable {
				text-align: center;
			}

			.index {
				font-size: 1.9rem;
			}

			.list-group a {
				margin-left: 5px;
			}

			table tbody tr td {
				width: 200px;
			}

			#list-item-1,
			#list-item-2,
			#list-item-3,
			#list-item-4,
			#list-item-5,
			#list-item-6,
			#list-item-7,
			#list-item-8
			{
				padding-top: 10px;
				padding-bottom: 10px;
				padding-left: 1rem;
			}
			.dt-button.icon_:before {
				color: #fff;
				padding-top: 10px;
				content: "\f019";
				font-family: FontAwesome;
				font-size: 20px;
			}
			.dt-button.icon_{
				background-color: #17a2b8;
				border-color: #17a2b8;
			}
			.dt-button {
				margin-top: 5px;
			}
			/* datatable search */
			.dataTables_filter {
				margin-top: 5px;
			}
			/* datatable info */
			.dataTables_info {
				margin-left: -30px;
			}
			
			.dataTables_length {
				margin-top: 5px;
			}
			.container {
				margin-top: 1rem;
				margin-bottom: 1rem;
			}

			h3 {
				/* color: cornflowerblue; */
				color: #17a2b8; margin-bottom: 20px;
				font-weight: bolder;
			}

			/* 左侧导航颜色 */
			.list-group-item.active {
				background-color: #17a2b8;
				border: 1px solid rgba(0, 0, 0, .125);
			}

			#list-example a {
				padding-left: 15px;
			}

			/* 基本信息样式 */
			#basic_info tbody tr td {
				vertical-align: middle;
			}

			/* 		.navbar.navbar-dark.text-white.bg-dark{padding-left: 30px;}
		#navbar-example3{
			position: fixed;
			width: 300px;
			margin-left: 30px;
			border: 1px solid #000000;
			border-radius: 10px 10px 10px 10px;
			height: 580px;
			margin-bottom: 50px;
		}
		#navbar-example3 a{
			padding-top: 1px;
			padding-bottom: 1px;

		} */
			.nav-link {
				margin-bottom: 1px;
			}
			.nav-pills .nav-link.active, .nav-pills .show>.nav-link {
				margin-bottom: 1px;
				color: #17a2b8;
				background-color: #ffffff;
			}
			a{color: #FFFFFF;}
			a:hover {color: #FFFFFF;}
			.dropdown-item.active, .dropdown-item:active {
				color: #ffffff;
				background-color: #17a2b8;
			}
			.p1 {border: 0px;border-top: 0px;margin: 0px;}
			.p2 { border: 0px;border-top: 0px;width: 100%;margin: 0px;display: none;}

			/* go back to top */
			#myBtn {
			    display: none; /* 默认隐藏 */
			    position: fixed;
			    bottom: 20px;
			    right: 30px;
			    z-index: 99;
			    border: none;
			    outline: none;
			    background-color: red; /* 设置背景颜色，你可以设置自己想要的颜色或图片 */
			    color: white; /* 文本颜色 */
			    cursor: pointer;
			    padding: 15px;
			    border-radius: 10px; /* 圆角 */
			}

			#myBtn:hover {
			    background-color: #555;
			}

		</style>
		<script>
			function changeTab(id) {
				// 处理tab
				$('#myTab li a').removeClass('active')
				$('#menu1_tab').parent().children().eq(0).children().eq(0).css('background', '#ffffff')
				$('#menu1_tab').parent().children().eq(0).children().eq(0).css('color', '#17a2b8')

				// 处理tabContent
				$('#myTabContent div').removeClass('active')
				// $('#myTabContent div').addClass('fade')
				$('#' + id).removeClass('fade')
				$('#' + id).addClass('active')
				$('#myTab li a').preventDefault()
			}
			// back to top
			window.onscroll = function() {scrollFunction()};

			function scrollFunction() {console.log(121);
			    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
			        document.getElementById("myBtn").style.display = "block";
			    } else {
			        document.getElementById("myBtn").style.display = "none";
			    }
			}

			// 点击按钮，返回顶部
			function topFunction() {
			    document.body.scrollTop = 0;
			    document.documentElement.scrollTop = 0;
			}

		</script>
	</head>

	<body data-spy="scroll" data-target="#list-example" style="padding-top: 0px;">
		<!-- 导航栏 -->
		{% include 'public_templates/nav_tem.html' %}
		{% csrf_token %}
		<button onclick="topFunction()" id="myBtn" title="backtotop" style="background: #17a2b8;">TOP</button>
		<!-- 主体内容 -->
		<div class="container-fluid col-10">
			<div class='row'>
				<div class='col-2 d-none d-xl-block' style="margin: 1rem 50px 1rem 0rem;">
					<div id="list-example" class="list-group "
						style="position: fixed; width:250px;height: 500px;margin-left: -50px;padding-left: 0;">
						<a class="list-group-item list-group-item-action" href="#list-item-1">Gene Information</a>
						<a class="list-group-item list-group-item-action" href="#list-item-2">Model Results</a>
						<a class="list-group-item list-group-item-action" href="#list-item-3">Gene Expression Patterns</a>
					</div>
				</div>
				<div class='col-xl-9 col-lg-12'>
					<div data-spy="scroll" data-target="#list-example" data-offset="0" class="panel panel-primary">
						<h3 class="panel-heading" id="list-item-1" style="margin: 1rem 0 0rem 0 ;background-color: #17a2b8;color: #ffffff;">
							Gene Information
						</h3>
						
						<div class="container col-12">
							<div class="row">
								<div class="col-12" style="padding: 0;">
									<table id="gene_info" class="table table-bordered">
										<tbody>
											<tr>
												<td class=" bg-light" style="width:5%">Temporal Gene</td>
												<td colspan="1">{{curr_geneinfo.0.gene |safe}}</td>
												<td class=" bg-light" style="width: 5%;">Entrez ID</td>
												<td colspan="1">{{curr_geneinfo.0.geneid}}</td>
											</tr>
											<tr>
												<td class=" bg-light">Synonyms</td>
												<td colspan="3" style="width: 100%;">{{curr_geneinfo.0.synonyms}}</td>
											</tr>
											<tr>
												<td class=" bg-light ">Description</td>
												<td colspan="3" style="width: 100%;">{{curr_geneinfo.0.description}}</td>
											</tr>
											<tr>
												<td class=" bg-light">Organism</td>
												<td colspan="3" style="width:100%">{{curr_geneinfo.0.specie}}</td>
											</tr>
										</tbody>
									</table>
									<table id="basic_info" class="table table-bordered">
										<tbody>
											<tr>
												<td class=" bg-light">Time</td>
												<td colspan="2" style="width:100%">{{ curr_study.0.time }}</td>
											</tr>
											<tr>
												<td class=" bg-light">Unit</td>
												<td colspan="2" style="width:100%">{{curr_study.0.unit}}</td>
											</tr>
											<tr>
												<td class=" bg-light">Tissue/Cell Type</td>
												<td colspan="2" style="width:100%">{{curr_study.0.tissue_cell_type}}</td>
											</tr>
											<tr>
												<td class=" bg-light">Project ID</td>
												<!-- <td colspan="2" style="width:100%">{{curr_study.0.studyid}}</td> -->
												<td colspan="2">
												    <a style="color:#0000ff" href="../detail/{{curr_study.0.studyid}}" >{{curr_study.0.studyid}}</a>
												</td>
											</tr>
											<tr>
												<td class="bg-light">Accession</td>
												<td colspan="2">
													<a target="_blank" href="
														{% if curr_study.0.data_source == 'GEO' %}
														https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc={{ curr_study.0.accession }}
														{% else %}
														https://www.ebi.ac.uk/arrayexpress/experiments/{{ curr_study.0.accession }}
														{% endif %}
													" style="color: #0000ff;">
														{{ curr_study.0.accession }}
													</a>
												</td>
											</tr>
											<tr>
												<td class=" bg-light">Experiment Type</td>
												<td colspan="2" style="width:100%">{{curr_study.0.experiment_type}}</td>
											</tr>
											<tr>
												<td class=" bg-light">Pubmed ID</td>
												<td colspan="2"><a href="https://pubmed.ncbi.nlm.nih.gov/{{curr_study.0.pmid}}" style="color: #0000ff;">{{curr_study.0.pmid}}</a></td>
											</tr>
										</tbody>
									</table>
							
								</div>
							</div>
						</div>
								<h3 class="panel-heading" id="list-item-2"
															style="margin: 1rem 0 0rem 0 ;background-color: #17a2b8;color: #ffffff;">Model Results
														</h3>
								<!-- <script>
									var cluster = {{ cluster|safe }};
								</script> -->
								<br>
								<p>Note: Equations and parameters will be output only for fitted models meeting the criteria.</p>
								{% if cluster == "cluster0" %}
									<div class="container col-12">
										<table id="ModelDF" class="display" style="width: 100%;" lazyload="True">
											<thead>
												<tr>
													<th>Cluster</th>
													<th>Model</th>
                                                    <th>Model Formula</th>
													<th>Parameters</th>
													<th>CV Value</th>
                                                    <th>RMSE</th>
													<th>R^2</th>
													<th>adj.R^2</th>
													<th>AIC</th>
												</tr>
											</thead>
										</table>
									</div>
									<script>
										var ModelDF_df = {{ ModelDF_df|safe }};
										<!--第三步：初始化Datatables-->
										$(document).ready(function() {
											$('#ModelDF').DataTable({
												data: ModelDF_df,
												//order: [[ 4, "asc" ],[ 3, "desc"]],
												dom: "<'row'<'col-sm-12 col-md-1'B><'col-sm-12 col-md-8'i><'col-sm-12 col-md-3'f>>" +
													 "<'row'<'col-sm-12'tr>>" +
													 "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'p>>",
												buttons: [{
													extend: 'csv',
													text: "",
													className: "icon_",
												}],
												columns: [
													{ data: 'cluster' },
													{ data: 'model' },
                                                    { data: 'exp' },
													{ data: 'parameters' },
													{ data: 'cv' },
                                                    { data: 'RMSE' },
													{ data: 'Rsq' },
													{ data: 'Adj_Rsq' },
													{ data: 'AIC' },
												]
											});
										});
									</script>
								{% else %}
									<div class="container col-12">
										<table id="ModelDF" class="display" style="width: 100%;" lazyload="True">
											<thead>
												<tr>
													<th>Cluster</th>
													<th>Model</th>
                                                    <th>Model Formula</th>
													<th>Parameters</th>
                                                    <th>RMSE</th>
													<th>R^2</th>
													<th>adj.R^2</th>
													<th>AIC</th>
												</tr>
											</thead>
										</table>
									</div>
									<script>
										var ModelDF_df = {{ ModelDF_df|safe }};
										<!--第三步：初始化Datatables-->
										$(document).ready(function() {
											$('#ModelDF').DataTable({
												data: ModelDF_df,
												//order: [[ 4, "asc" ],[ 3, "desc"]],
												dom: "<'row'<'col-sm-12 col-md-1'B><'col-sm-12 col-md-8'i><'col-sm-12 col-md-3'f>>" +
													 "<'row'<'col-sm-12'tr>>" +
													 "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'p>>",
												buttons: [{
													extend: 'csv',
													text: "",
													className: "icon_",
												}],
												columns: [
													{ data: 'cluster' },
													{ data: 'model' },
                                                    { data: 'exp' },
													{ data: 'parameters' },
                                                    { data: 'RMSE' },
													{ data: 'Rsq' },
													{ data: 'Adj_Rsq' },
													{ data: 'AIC' },
												]
											});
										});
									</script>
								{% endif %}
								
								<!-- <div class="container col-12">
									<div class="row">
										<div class="col-12" style="padding: 0;">
											<div id="heatmap"></div>
										</div>
									</div>
								</div> -->
								<h3 class="panel-heading" id="list-item-3" style="margin: 1rem 0 0rem 0 ;background-color: #17a2b8;color: #ffffff;">
									Time Series Trend Chart
								</h3>
								<div class="border border-secondary rounded" style="padding: 1rem;">
								    <form id="Form1" action="/GeTeSEPdb/gene_detail/{{ gene }}" method="get">
								        <div class="container col-12">
								            <div class="row">
								                <div class="form-group col-6" style="padding-left: 0rem;margin-bottom: 0.3125rem;">
								                    <label for="ModelForm1" style="margin-bottom: 0rem;">Model:</label>
								                    <select class="form-control" id="ModelForm1" onchange="updateCharts()" name="model">
								                        {% for model_value in model_list %}
								                        <option {% if model == model_value %} selected="selected" {% endif %} value='{{ model_value }}'>{{ model_value }}</option>
								                        {% endfor %}
								                    </select>
								                </div>
								            </div>
								        </div>
								    </form>
								</div>
								<div id="line-chart"></div>


						</div>
				</div>
			</div>
		</div>

		<!-- 底栏 -->
		{% include 'public_templates/footer.html' %}
		<!-- <form >
			<input style="display: none;" type="text" id="studyid"  name="studyid" value="{{curr_study.studyid}}"/>
		</form> -->


		<script>
			// function getCookie(name) {
			// 		let cookieValue = null;
			// 		if (document.cookie && document.cookie !== '') {
			// 			const cookies = document.cookie.split(';');
			// 			for (let i = 0; i < cookies.length; i++) {
			// 				const cookie = cookies[i].trim();
			// 				// Does this cookie string begin with the name we want?
			// 				if (cookie.substring(0, name.length + 1) === (name + '=')) {
			// 					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			// 					break;
			// 				}
			// 			}
			// 		}
			// 		return cookieValue;
			// 	}
			// 	const csrftoken = getCookie('csrftoken');

			var csrftoken = $("input[name='csrfmiddlewaretoken']").attr('value');
			
			// $('#geneSearch').submit(function(e){
			// 			e.preventDefault();
			// 			if (sampleType=='tissue'){reset_content(show_ref=true);}else{reset_content();}
			// 			serializedData = $(this).serialize();
			// 			split = serializedData.split('=');
			// 			searchedGene = split[1].toUpperCase();
			// 			postData = split[0] + '=' + searchedGene;
			// 			commonSearchOpt = $('.search-options input').serialize();
			// 			postData = postData + '&' + commonSearchOpt + '&sampleType=' + sampleType;
			// 			$.ajax(ajaxGeneSearch(postData));
			// 			$('#loader_sc_pct').show();
			// 			$('#spec_plot_div').show();
			// 			$('#gtexTissues').hide();
			// 			$('#scExpPercentBar').hide();
			// 			$.ajax(odb_ajax('/organoid_db/general/get_gene_info', postData))
			// 			 .then(function(data, status){
			// 				update_general_gene_info([data, status]);
			// 				$('#gene_info_div').show();
			// 			});
			// 		});

		</script>
    <!-- <script type="application/json" id="heatmapData">{{ heatmap_data | safe }}</script> -->
								<script type="application/json" id="trend_data">{{ trend_data | safe }}</script>
								<script>
									// var heatmap_data = {{ heatmap_data | safe }};
									var trend_data = {{ trend_data | safe }};
									var trend_data_line = {{ tread_data_line | safe }}
									var x_Axis = {{ x_Axis | safe}}

									function updateCharts() {
										var selectedmodel = document.getElementById('ModelForm1').value;
										// var time = trend_data.x.length

										var geneData = trend_data[selectedmodel].y;
										var gene = trend_data[selectedmodel].z;
										// console.log(trend_data)
										var traceData = [];
										var trace1 = {
											x: x_Axis,
											// x:time,
											y: geneData,
											name: gene,
                                            name: "expression value",
											mode: 'markers',
											// type: 'scatter'
										};
										var trace2 = {
										  x: trend_data_line[selectedmodel].x,
										  y: trend_data_line[selectedmodel].y,
										  mode: 'lines',
										  name: 'predicted value'
										};
										var traceData = [trace1,trace2];

										var lineChartLayout = {
											title: 'Time Series Trend Chart',
											xaxis: {
												title: 'Time Series'
											},
											yaxis: {
												title: 'Gene Expression Value'
											}
										};

										Plotly.newPlot('line-chart', traceData, lineChartLayout);
									}
								// Initialize the charts with the selected cluster
								updateCharts();
								</script>
	</body>
</html>